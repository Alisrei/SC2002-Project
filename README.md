Updated to be able to compile testmain
Code after I edited so that it can complie, added  and changed a lot of functionality, still very incomplete though.
